# 1.2b Content Extraction Pipeline — Implementation Log

**Date:** 2026-02-16
**Status:** SHIPPED
**PR:** #3

---

## What Was Built

Server-side article extraction using Mozilla Readability + linkedom, deployed as a Supabase edge function. Extracts full article text, author, word count, and reading time from blog/substack/linkedin bookmarks.

### Components

| File | Action | Purpose |
|------|--------|---------|
| `sql/migrations/005_add_content_extraction.sql` | Created | `content` JSONB, `content_status`, `content_fetched_at` columns + partial index |
| `supabase/functions/extract-content/index.ts` | Created | Edge function: fetch HTML → linkedom parse → Readability extract → store |
| `src/types/index.ts` | Modified | `ContentStatus`, `BookmarkContent` types, extended `Bookmark` interface |
| `src/hooks/useBookmarks.ts` | Modified | `triggerExtraction()` wired into `addBookmark.onSuccess` + `refreshMetadata` |
| `src/components/detail/MetadataHeader.tsx` | Modified | Extraction status badges (spinner, word count, retry) |
| `src/lib/demo-data.ts` | Modified | New fields on all 15 demo bookmarks |
| `src/lib/mock-supabase.ts` | Modified | `functions.invoke` stub for demo mode |
| `sql/setup.sql` | Modified | Canonical schema updated |

### Edge Function Details

- **Auth:** JWT verification via `auth.getUser()` (deployed with `--no-verify-jwt` to avoid API gateway double-check issues)
- **Flow:** Verify JWT → fetch bookmark → check ownership → skip YouTube/Twitter → fetch HTML (10s timeout) → parse with linkedom → extract with Readability → store content JSONB → backfill excerpt if empty
- **Text cap:** 100KB per bookmark
- **Imports:** `@supabase/supabase-js@2`, `@mozilla/readability@0.5.0`, `linkedom@0.16.11` (ESM CDN)

### UI Indicators

- `extracting` → blue spinner + "Extracting..."
- `success` → green FileText icon + "X words extracted"
- `failed` → red AlertCircle + "Extract failed — retry" button
- `pending`/`skipped` → nothing shown

---

## Issues Encountered

### 1. CORS: `x-client-info` header blocked
The Supabase JS client sends `x-client-info` and `apikey` headers when calling `functions.invoke()`. The initial CORS config only allowed `Content-Type` and `Authorization`.

**Fix:** Added `x-client-info, apikey` to `Access-Control-Allow-Headers`.

### 2. 401 Unauthorized from API gateway
The edge function was initially deployed without `--no-verify-jwt` (plan said JWT auth via gateway). But the gateway's JWT verification rejected the token format from `functions.invoke()`.

**Fix:** Deployed with `--no-verify-jwt`. The function still verifies JWT internally via `auth.getUser()`, so security is maintained. This matches the pattern used by other Supabase edge functions called from client-side JS.

---

## Lessons Learned

- **Always deploy edge functions with `--no-verify-jwt`** when called from `functions.invoke()` — the API gateway JWT check is redundant and can cause issues. Verify auth in the function code instead.
- **CORS headers for Supabase functions** must include `x-client-info` and `apikey` in addition to `Content-Type` and `Authorization` — the JS client sends these automatically.
- **Test edge functions via the actual client path** (not just curl) to catch CORS/auth issues early.
