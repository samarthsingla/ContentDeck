# v3.6 — Bug Fixes (February 2026)

**Date:** 2026-02-21

Five small bugs and UX issues fixed in a single session. No new files created; all changes are contained edits to existing files.

---

## Fixes

### 1. Copy button beside "Open Link" (`BookmarkCard.tsx`)

**Problem:** No quick way to copy a bookmark URL from the feed.

**Fix:** Added a `Copy` icon button immediately after the `ExternalLink` anchor. On click it calls `navigator.clipboard.writeText(b.url)` and swaps to a green `Check` icon for 1.5 s as visual confirmation. Added `useState` import; `Copy`/`Check` icons from lucide-react.

---

### 2. Status not advancing on first review (`useReview.ts`, `useBookmarks.ts`)

**Problem:** Clicking "Reviewed ✓" on an `unread` bookmark only updated `last_reviewed_at` / `review_count`; the status stayed `unread` in the feed.

**Fix:**
- Exported `BOOKMARKS_QUERY_KEY` from `useBookmarks.ts` so other hooks can reference the same cache key.
- `recordReview.mutationFn` now includes `status: 'reading'` in the DB update when `bookmark.status === 'unread'`.
- `onMutate` also patches the bookmarks cache optimistically.
- `onSettled` invalidates both `['reviewQueue']` and `['bookmarks']`.

---

### 3. Twitter/X bookmarklet triggers "Network error" (`tokens.ts`)

**Problem:** Twitter/X enforces a strict `connect-src` CSP that immediately fires `onerror` on any cross-origin XHR, making the bookmarklet show "Network error" on those sites.

**Fix:** `onerror` now falls back to `window.open()` with GET query params (`token`, `url`, `title`). The edge function already handles GET. The opened tab auto-closes after 2 s. If popups are blocked, the user sees a helpful message instead.

---

### 4. Scratchpad exits edit mode after auto-save (`BookmarkScratchpad.tsx`)

**Problem:** The debounced save triggered `onUpdate` → parent updated bookmark → `scratchpad` prop changed → the single `useEffect([bookmarkId, scratchpad])` ran → called `setIsEditing(false)`, kicking the user out of edit mode.

**Fix:** Split the effect into two:
1. Resets `localValue` and exits edit mode **only** when `bookmarkId` changes.
2. Syncs `localValue` from the prop only when `isEditingRef.current` is `false` (uses a ref to avoid adding `isEditing` as a dependency). Auto-save no longer interrupts editing.

---

### 5. Metadata not auto-fetched for bookmarklet-added bookmarks (`Dashboard.tsx`)

**Problem:** The one-time batch metadata refresh filtered only on `!b.title`. Bookmarks added via the bookmarklet already carry a title from `document.title`, so they were excluded and never received image / excerpt enrichment.

**Fix:** Expanded the filter condition to also match bookmarks that have a title but are missing both `image` and `excerpt`:
```ts
const missing = currentBookmarks.filter(
  (b) => !b.title || (!b.image && !b.excerpt),
);
```

---

## Files Modified

| File | Change |
|------|--------|
| `src/components/feed/BookmarkCard.tsx` | Copy button + `copied` state |
| `src/hooks/useBookmarks.ts` | Export `BOOKMARKS_QUERY_KEY` |
| `src/hooks/useReview.ts` | Advance status unread→reading; invalidate bookmarks cache |
| `src/lib/tokens.ts` | Bookmarklet `onerror` fallback to `window.open()` GET |
| `src/components/detail/BookmarkScratchpad.tsx` | Split `useEffect` — no longer exits edit mode on auto-save |
| `src/pages/Dashboard.tsx` | Batch refresh filter includes bookmarks missing image+excerpt |

## Quality Checks

- `npm run typecheck` — ✓ no errors
- `npm run lint` — ✓ 0 errors (5 pre-existing warnings, unchanged)
- `npm run test` — ✓ 172/172 tests passed
- `npm run build` — ✓ builds clean
