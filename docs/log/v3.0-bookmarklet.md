# v3.0 — Bookmarklet Fix (1.1a) — Implementation Log

**Status:** ✅ DONE — VERIFIED WORKING

## Why
Power users on desktop need a one-click save from any page. The bookmarklet broke when v3.0 removed the raw anon key approach.

## Approach
- Supabase Edge Function `POST /save-bookmark` that accepts a user API token
- User generates a personal API token in Settings (stored in `user_tokens` table)
- Bookmarklet sends URL + title + token to the edge function via JSON body
- Edge function validates token hash → inserts bookmark with correct `user_id`
- Settings UI: "Generate Bookmarklet" → draggable link + copy code button
- Token revocation in Settings

## Bugs Fixed
1. `createToken` mutation needed explicit `user_id` from `db.auth.getUser()`
2. Edge function needed `--no-verify-jwt` deployment (custom token auth, not Supabase JWT)
3. `set_user_id()` trigger overwrote explicit `user_id` with `auth.uid()` (NULL for service role) — fixed with `COALESCE(NEW.user_id, auth.uid())`
4. Token/URL injection in bookmarklet JS — fixed with `jsStringEscape()`

## Shared Infrastructure (1.1a + 1.1b)

### User Tokens Table
```sql
CREATE TABLE user_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) NOT NULL,
  name TEXT NOT NULL,
  token_hash TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now(),
  last_used_at TIMESTAMPTZ
);
CREATE INDEX idx_user_tokens_hash ON user_tokens(token_hash);

-- RLS
ALTER TABLE user_tokens ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users see own tokens" ON user_tokens
  FOR ALL USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);
```

### Edge Function (`supabase/functions/save-bookmark/index.ts`)
- Accepts fields via query params (priority) OR JSON/form body (fallback)
- `extractFields()` — query params → JSON → form-encoded → fallback
- Validates URL scheme (http/https only)
- Looks up `token_hash` → gets `user_id`
- Inserts into `bookmarks` with explicit `user_id` (COALESCE trigger preserves it)
- Returns `201` with bookmark ID or `401` on bad token
- Deployed with `--no-verify-jwt` (custom token auth)
