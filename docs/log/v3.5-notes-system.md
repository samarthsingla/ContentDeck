# v3.5 — Notes System (Phase 2 Complete)

**Branch:** `feat/12-notes` | **Issue:** #12 | **Date:** 2026-02-20
**Shipped:** Phases 2.1–2.5 — standalone notes, TipTap editor, bookmark linking, area tagging, Markdown export

---

## What Was Built

ContentDeck is now a thinking tool, not just a bookmark manager. Users can create rich-text notes, link them to bookmarks bidirectionally, tag them with areas, and export to Markdown.

### Phase 2.1 (pre-existing) — Schema + Hook + Demo Data
- `notes`, `note_bookmarks`, `note_tags` tables with RLS
- `useNotes` hook (TanStack Query, optimistic updates)
- Mock Supabase support; `DEMO_STANDALONE_NOTES` demo data

### Phase 2.2 — Notes List View
- `'notes'` added to `ViewMode`; duplicate types removed from `src/types/index.ts`
- **Sidebar**: "Notes" nav entry with count, correct active-state isolation from bookmarks
- **AppShell + MobileNav**: `noteCount` prop threaded; Notes tab (FileText icon, 56px)
- **`StandaloneNoteCard`**: `role="button"`, HTML-stripped preview (100 chars), area pills, linked bookmark count, hover-reveal delete with confirmation
- **`NotesList`**: 2-col grid, `searchQuery` filter from `useUI()`, loading spinner, empty state CTA

### Phase 2.3 — TipTap Editor + Auto-save
- **`TipTapEditor`** (lazy-loaded chunk): StarterKit + Link + Placeholder; toolbar with `role="toolbar"`, `aria-label`, `aria-pressed`
- **`NoteEditorModal`**: `React.lazy` + `Suspense`, 1-second debounced auto-save, bootstraps note ID on first content, Saving/Saved indicator, flush-on-close, ESC to close
- **Markdown export**: downloads `.md` via anchor click, uses `convertHtmlToMarkdown()`
- **`NoteCard`** + **`NotesTab`**: `onPromote` prop (ArrowUpRight) to promote inline annotation to standalone note

### Phase 2.4 — Bookmark Linking
- **`useNoteBookmarks`**: two-step query (junction → bookmarks), `linkBookmark`/`unlinkBookmark` mutations
- **`LinkedBookmarks`**: combobox search (`role="combobox"`, `aria-expanded`, `role="listbox"`, `role="option"`), favicon + title list, unlink button
- **`useLinkedNoteIds`**: reverse lookup bookmark→notes (for DetailPanel)
- **DetailPanel**: "Linked Notes" section with clickable titles + "New Note" button; "Promote to Note" button on inline notes; `onCreateNoteForBookmark` opens editor pre-linked
- **Dashboard**: wires pending bookmark link after note creation bootstraps an ID

### Phase 2.5 — Areas + Export + Polish
- **`useNoteTags`**: mirrors `useNoteBookmarks` for `note_tags` junction
- **Area picker** in `NoteEditorModal`: colored chips (click to remove) + select dropdown (filtered to unassigned areas)
- **`convertHtmlToMarkdown()`** in `src/lib/utils.ts`: handles h1–h3, bold, italic, inline code, code blocks, links, lists, HTML entity decode, deduplication of newlines
- **Vite chunk splitting**: `manualChunks: { tiptap: ['@tiptap/react', '@tiptap/starter-kit'] }` → `tiptap-*.js` ~165KB gzip, separate from 108KB main bundle

---

## Key Files Changed / Created

| File | Change |
|------|--------|
| `src/types/index.ts` | Removed duplicates; added `'notes'` to `ViewMode` |
| `src/components/layout/Sidebar.tsx` | Notes nav button, noteCount prop |
| `src/components/layout/AppShell.tsx` | noteCount threading |
| `src/components/layout/MobileNav.tsx` | Notes tab, noteCount prop |
| `src/components/notes/StandaloneNoteCard.tsx` | **New** |
| `src/components/notes/NotesList.tsx` | **New** |
| `src/components/notes/TipTapEditor.tsx` | **New** (lazy chunk) |
| `src/components/notes/NoteEditorModal.tsx` | **New** |
| `src/components/notes/LinkedBookmarks.tsx` | **New** |
| `src/components/detail/NoteCard.tsx` | onPromote prop |
| `src/components/detail/NotesTab.tsx` | onPromoteToNote prop |
| `src/components/detail/DetailPanel.tsx` | linkedNotes + note action props |
| `src/hooks/useNoteBookmarks.ts` | **New** |
| `src/hooks/useLinkedNoteIds.ts` | **New** |
| `src/hooks/useNoteTags.ts` | **New** |
| `src/lib/utils.ts` | `convertHtmlToMarkdown()` |
| `src/pages/Dashboard.tsx` | useNotes, NotesList view, NoteEditorModal wiring |
| `vite.config.ts` | TipTap manual chunk |
| `src/components/__tests__/StandaloneNoteCard.test.tsx` | **New** (7 tests) |
| `src/components/__tests__/NotesList.test.tsx` | **New** (5 tests) |
| `src/hooks/__tests__/useNotes.test.ts` | **New** (6 tests) |

---

## Decisions + Gotchas

**`@tiptap/pm` has no root export** — cannot be used in `manualChunks` directly. Use `@tiptap/react` and `@tiptap/starter-kit`; ProseMirror is included transitively.

**Auto-save bootstrap**: A note has no DB ID until the first save. `NoteEditorModal` tracks `noteId` in state, bootstraps it on first debounced save, then links any pending `initialBookmarkId` via a `useEffect` watching `noteId`.

**Mock builder shares `_resolve`**: The chainable Supabase mock in tests returns the same `_resolve` for all operations on a table. Tests that change `_resolve` between initial load and mutation need to test behaviors (toast calls, DB mock invocations) rather than cache state to avoid fragile assertions.

**`aria-expanded` on textbox**: ARIA spec forbids `aria-expanded` on implicit `textbox` role. Fix: add `role="combobox"` explicitly to the search input.

**TipTap chunk warning**: Vite warns chunks > 500KB. The `tiptap` chunk is ~514KB minified (~165KB gzip) — this is normal for ProseMirror runtime and acceptable for a lazy-loaded editor.

---

## Quality Gate Results

| Check | Result |
|-------|--------|
| `format:check` | ✅ |
| `lint` | ✅ 0 errors, 5 pre-existing warnings |
| `typecheck` | ✅ |
| `test` | ✅ 152/152 (+19 new) |
| `build` | ✅ TipTap in separate chunk |
