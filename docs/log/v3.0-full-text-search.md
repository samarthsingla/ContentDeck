# v3.0 — Full-Text Search (1.3)

**Shipped:** 2026-02-18
**Issue:** [#4](https://github.com/aditya30103/ContentDeck/issues/4)
**PR:** feat/4-full-text-search

---

## What Was Built

Extended client-side search to cover extracted article content (excerpt + content.text), added a result count indicator, and debounced the search input to prevent jank on long text fields. Also added a PostgreSQL `tsvector` + GIN index for future server-side ranked search.

---

## Key Decisions

### Client-side search (not server-side)

Dataset is personal/small — client-side filtering is instant with zero latency. Server-side `tsvector` is provisioned (SQL migration ready) for future use if the dataset grows or ranked relevance is needed.

### Debounce at SearchBar level, not context level

Local state (`localValue`) tracks the input for immediate visual feedback; a 200ms `useEffect` timer propagates to `UIProvider.searchQuery`. This means:
- The input always feels responsive
- The filter computation only fires after the user pauses

External clear (e.g. `setSearch('')` from somewhere else) is synced back via a `searchQuery === ''` effect.

### Result count — singular/plural

"1 result for …" vs "N results for …" — shown via `aria-live="polite"` so screen readers announce it without interrupting.

### `tsvector` weights

title (A) > excerpt (B) > content.text (C). Auto-maintained via `GENERATED ALWAYS AS ... STORED` — no triggers needed, updates on every row change.

---

## Files Changed

| File | Change |
|------|--------|
| `supabase/migrations/20260218_full_text_search.sql` | New — tsvector column + GIN index |
| `sql/setup.sql` | Added search_vector column + index to reference schema |
| `src/components/feed/BookmarkList.tsx` | Extended search filter (`excerpt`, `content.text`); added result count `<p>` |
| `src/components/feed/SearchBar.tsx` | Added 200ms debounce via local state + useEffect |
| `src/lib/demo-data.ts` | Added `excerpt` to demo-7, 8, 9, 15 for demo-mode search coverage |
| `src/components/__tests__/BookmarkList.test.tsx` | New — 11 tests covering search by title, excerpt, content.text, tags, result count, empty state |
| `public/sw.js` | Bumped CACHE_NAME to v3.0.4 |

---

## Gotchas

- `b.content?.text` — `content` is `BookmarkContent | {}`, so optional chaining is required on both the object and the `.text` property
- Do NOT add `content.excerpt` to the search filter — the extracted content's `excerpt` lives in `BookmarkContent.excerpt` (inside the JSONB blob), while the top-level `Bookmark.excerpt` is the metadata excerpt. Only the top-level one is searched (matching the tsvector definition)
- `GENERATED ALWAYS AS STORED` requires PostgreSQL 12+ (Supabase uses PG 15, no issue)

---

## Test Results

- Total: 106 tests (was 95, +11 new BookmarkList tests)
- All 10 test files pass
