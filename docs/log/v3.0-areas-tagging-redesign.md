# v3.0 Areas & Tagging Redesign — Two-Tier Model

**Date:** 2026-02-17
**Commit:** `34eff31`
**Scope:** Database migration, hooks, AI prompt, UI components, demo mode

---

## Problem

The areas/tagging system had several bugs and architectural flaws:

1. **No unique constraint** on `tag_areas(name, user_id)` — duplicate areas could be created, and old v1 duplicates blocked new creation
2. **Areas and tags conflated** — both stored as `bookmarks.tags: string[]`, matched by name string. The `bookmark_tags` junction table existed in the schema but was completely unused
3. **AI tagging blind to areas** — the prompt only saw existing bookmark tag strings, not area names. `suggestedArea` response field was parsed but never consumed
4. **No autocomplete** — tag input was pure free-text with no awareness of existing areas or tags
5. **No area lifecycle management** — no rename cascade, no delete cleanup

## Solution: Two-Tier Model

**Areas** = user-defined categories (explicit, managed). Bookmarks belong to 0-N areas via the `bookmark_tags` junction table (FK-based, not name-based).

**Tags** = fine-grained labels (free-text `string[]` on bookmarks). AI-suggested + user-editable.

---

## Changes

### Database Migration

**File:** `supabase/migrations/20260217_areas_tagging_redesign.sql`

1. Clean up duplicate areas (keep oldest by `created_at`)
2. Add unique constraint: `tag_areas(user_id, name)`
3. Populate `bookmark_tags` junction from existing `bookmarks.tags` where tag matches an area name (case-insensitive, `CROSS JOIN LATERAL unnest`)

**Lesson learned:** PostgreSQL can't reference an implicit lateral join's base table in a regular `JOIN` — must use explicit `CROSS JOIN LATERAL unnest(b.tags) AS t`.

### TypeScript Types

**File:** `src/types/index.ts`

- Added `areas: TagArea[]` to `Bookmark` interface (populated via join)

### Hooks

**File:** `src/hooks/useTagAreas.ts`

- Client-side duplicate check in `createArea` (case-insensitive name match)
- Specific error toast: "Area '{name}' already exists"

**File:** `src/hooks/useBookmarks.ts`

- Joined query: `select('*, bookmark_tags(tag_area_id, tag_areas(*))')` — single Supabase REST call
- `RawBookmarkRow` interface for nested join data, `normalizeBookmark` flattens to `areas: TagArea[]`
- New mutations: `setAreas(bookmarkId, areas[])` — replaces all junction rows
- `updateBookmark` strips `areas` from DB updates (not a real column)
- `autoSuggestTags` updated to pass areas to AI, apply area assignments from response

### AI Prompt

**File:** `src/lib/ai.ts`

- `suggestTags(bookmark, existingTags, areas, signal?)` — new `areas` parameter
- Prompt includes user's area names, instructs AI to match 0-2 areas from the list
- Rules: don't invent area names, don't force-fit, suggest new areas only when clearly needed
- `AIResponse` type now includes `areas: string[]` and `suggestedArea?: string`

### UI Components

**New file:** `src/components/ui/TagAreaInput.tsx`

- Shared autocomplete component used in both Add and Edit modals
- Dropdown with two sections: Areas (colored pills with emoji) and Tags
- Keyboard navigation (arrow keys, Enter to select, Escape to close)
- Free-text entry still allowed for new tags (Enter or comma)

**File:** `src/components/modals/AddBookmarkModal.tsx`

- Replaced plain tag input with `TagAreaInput`
- `onAdd` callback includes `areaIds` — areas assigned after bookmark creation

**File:** `src/components/modals/EditBookmarkModal.tsx`

- Replaced plain tag input with `TagAreaInput`
- `onSave` receives `areaIds` — updates junction table alongside bookmark fields

**File:** `src/components/feed/BookmarkCard.tsx`

- Area pills displayed before tag pills (colored with emoji)
- Clicking area pill filters by area name

**File:** `src/components/feed/BookmarkList.tsx`

- `__untagged__` filter checks both empty tags AND empty areas
- Search matches area names too

**File:** `src/components/areas/AreasView.tsx`

- Counts use junction data: `b.areas?.some(a => a.id === area.id)`
- "Untagged" renamed to "Uncategorized" (bookmarks with no areas)

**File:** `src/components/areas/AreaManager.tsx`

- `bookmarkCountByArea` prop shows bookmark count per area
- Inline duplicate name validation on create/edit
- Delete confirmation shows affected bookmark count

### Dashboard Wiring

**File:** `src/pages/Dashboard.tsx`

- Computes `allTags` (unique tags for autocomplete) and `bookmarkCountByArea`
- Add/Edit modal callbacks handle area assignment via `setBookmarkAreas`
- Auto-tag effect checks both tags AND areas for "untagged" status

### Demo Mode

**File:** `src/lib/mock-supabase.ts`

- Mock `bookmark_tags` table with join support
- `attachBookmarkTags` method handles nested select syntax

**File:** `src/lib/demo-data.ts`

- All demo bookmarks have `areas: []`
- `DEMO_BOOKMARK_TAGS` — 11 junction entries mapping bookmarks to areas

---

## Verification Checklist

- [x] Duplicate area prevention (client-side + DB constraint)
- [x] AI tagging area-aware (matches existing areas, suggests new ones)
- [x] Area assignment via autocomplete in Add/Edit modals
- [x] Area rename works (FK-based, not name-based)
- [x] Area delete cascades junction rows
- [x] AreasView counts match junction data
- [x] BookmarkCard shows area pills with color + emoji
- [x] Demo mode supports all features
- [x] Build passes (format, lint, typecheck, build)
- [x] SQL migration applied successfully
