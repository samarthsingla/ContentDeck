# v3.0 — Reader Mode (1.5)

**Date:** 2026-02-18
**PR:** #10 (feat/6-reader-mode → main)
**Issue:** #6

---

## What was built

A full-screen, distraction-free reading overlay that renders extracted article content from the `content.text` field. Triggered from the DetailPanel when `content_status === 'success'`.

### Features
- **Full-screen overlay** (z-60) — covers both mobile slide-up panel and desktop sidebar
- **Reading progress bar** — 2px bar at top tracks scroll progress (0–100%)
- **Typography controls** — font size (S/M/L), font family (sans/serif), reader theme (light/dark/sepia)
- **Persisted preferences** — `useReaderPrefs` hook stores to `localStorage` key `reader_prefs`
- **Reading meta** — author, reading time, word count rendered below article title
- **Minutes remaining** — calculated from scroll position × word count ÷ 238 WPM
- **Status action** — "Start Reading" (unread→reading), "Mark Done" (reading→done), or "✓ Done" indicator
- **Accessibility** — `role="dialog"`, `aria-modal`, `aria-label`, ESC to close, 44px touch targets
- **Paragraph rendering** — `content.text.split(/\n{2,}/)` → `<p>` tags with `leading-relaxed`

### "Read" button in DetailPanel
- Shows when `content_status === 'success' && content?.text` exists (enabled)
- Shows disabled when `content_status === 'pending' | 'extracting'`
- Hidden when `content_status === 'failed' | 'skipped'`
- Added to both mobile (slide-up) and desktop (right sidebar) layouts

---

## Files changed

**Created:**
- `src/hooks/useReaderPrefs.ts` — localStorage-backed typography preferences
- `src/components/reader/ReaderModal.tsx` — full-screen reader overlay
- `src/components/__tests__/ReaderModal.test.tsx` — 13 component tests

**Modified:**
- `src/components/detail/DetailPanel.tsx` — Read button + `showReader` state + `<ReaderModal>`
- `src/lib/demo-data.ts` — added `content.text` to `demo-9` (Browser Design) and `demo-13` (useEffect); expanded `SAMPLE_CONTENT.text` for `demo-10` (Modular Monolith)
- `public/sw.js` — bumped cache to `contentdeck-v3.0.5`

---

## Key decisions

- **State in DetailPanel, not Dashboard** — `showReader` is local state inside `DetailPanel`. No prop drilling through Dashboard needed since `onCycleStatus` was already available in DetailPanel.
- **Custom full-screen overlay vs reusing `Modal`** — the existing `Modal` component has max-height constraints (`max-h-[88vh]`). Reader mode needed a true full-screen experience, so a custom component was correct.
- **Sepia theme** — Tailwind arbitrary values: `bg-[#f9f5ed] text-[#433422]`. No new CSS variables needed.
- **Paragraph splitting** — `content.text.split(/\n{2,}/)` handles both Unix (single `\n\n`) and runs of blank lines. Single `\n` within a paragraph are preserved as `<br>`.
- **Reading speed** — 238 WPM is the research-backed average silent reading speed. Used consistently for both initial "X min read" display and live "X min remaining" calculation.
- **Three demo bookmarks with content** — `demo-9`, `demo-10`, `demo-13` now have `content_status: 'success'` with realistic extracted text, making reader mode fully demonstrable in demo mode.

---

## Test coverage

13 new component tests in `ReaderModal.test.tsx`:
- Renders title, paragraphs, author, word count, reading time
- Shows "no content" when text is empty
- Calls `onClose` on ESC key and close button
- Shows correct status button per bookmark status (unread/reading/done)
- Calls `onCycleStatus` with correct next status
- Shows `✓ Done` indicator when status is already done
- Shows progress bar element
- Does not render when `open={false}`

**Total tests:** 119 (was 106, +13)

---

## Gotchas

- The `useReaderPrefs` hook reads localStorage in the state initializer, which runs once per mount. This is intentional — prefs update only on the next open after being changed in another session. Since the modal unmounts when closed, this is fine.
- `document.body.style.overflow = 'hidden'` is set when the reader opens and cleaned up in the effect return. This prevents the underlying scroll from moving while the reader is active.
- The `scrollHeight - clientHeight` calculation returns 0 for short content (content fits without scrolling). The handler guards against this with a `<= 0` check that sets progress to 1 immediately.
