# v3.6 — Review System (Phase 2b.1–2b.5)

**Branch:** `feat/14-review-system` | **Issue:** #14 | **Date:** 2026-02-21

## What Was Built

Deliberate review of saved bookmarks: every item becomes a knowledge piece surfaced for recall. This is the first mechanical step toward ContentDeck's guiding vision — boosting memory and recall rather than weakening it.

## Files Created

| File | Purpose |
|---|---|
| `sql/migrations/review-system.sql` | DB migration: `last_reviewed_at`, `review_count` columns + index + `get_review_queue` RPC |
| `src/hooks/useReview.ts` | Review queue query (via `rpc`), `recordReview` mutation, session-local `skipReview`, `dueCount` |
| `src/components/review/ReviewCard.tsx` | Single bookmark card: title, excerpt, areas, last-reviewed label, Reviewed + Skip actions, progress bar |
| `src/components/review/ReviewPane.tsx` | Wraps queue + card, empty state when all caught up |
| `src/hooks/__tests__/useReview.test.ts` | 3 unit tests: full queue, skip, optimistic removal |

## Files Modified

| File | Change |
|---|---|
| `src/types/index.ts` | Added `last_reviewed_at`, `review_count` to `Bookmark`; added `'review'` to `ViewMode` |
| `src/hooks/useBookmarks.ts` | `normalizeBookmark`: defaults for new fields |
| `src/lib/demo-data.ts` | All 15 `DEMO_BOOKMARKS` entries: `last_reviewed_at: null, review_count: 0` |
| `src/lib/mock-supabase.ts` | Added `rpc()` method handling `get_review_queue` |
| `src/components/ui/Badge.tsx` | `statusLabels.done` → `'Read'` (more accurate: completed reading) |
| `src/components/feed/StatusFilters.tsx` | `labels.done` → `'Read'` |
| `src/components/layout/Sidebar.tsx` | Review nav item with Brain icon + orange `dueCount` badge |
| `src/components/layout/MobileNav.tsx` | Replaced Done status tab with Review view tab |
| `src/components/layout/AppShell.tsx` | Threaded `dueCount` prop to Sidebar + MobileNav |
| `src/pages/Dashboard.tsx` | `useReview` wired; `dueCount` to AppShell; `'review'` case in view renderer |
| `public/sw.js` | Cache bumped to `v3.2.0` |

## Key Decisions

- **Skip is session-only** — no DB write. Items return to the queue next session. This keeps the DB simple and prevents "gaming" the spaced repetition.
- **7-day interval** — fixed for now; adaptive SRS deferred to Phase 4. All items are due if never reviewed or last reviewed > 7 days ago.
- **Done → Read label** — better communicates the meaning (content was consumed). "Done" implied finality; "Read" is accurate without implying the knowledge work is done.
- **Mobile: Done tab removed** — MobileNav has 6 items; adding Review without removing something would crowd it. Done is still reachable via the status filter chips in list view.
- **`rpc()` on mock client** — added directly to the mock object (not via `MockQueryBuilder`) since RPCs return flat arrays, not chainable queries.

## Gotchas

- TypeScript: `db.rpc(...)` returns `any` without DB schema types. Added `// eslint-disable-next-line @typescript-eslint/no-unsafe-assignment` on the destructure line.
- Test fixture: added `last_reviewed_at: null, review_count: 0` to all existing bookmark fixtures in 6 test files.
- StatusFilters test: regex `/Read/i` matches "Unread" too — changed to `/^Read\s/i`.
- Review test: `recordReview` `onSettled` triggers refetch; test must mock `rpc` to return filtered queue on second call.

---

## Phase 2b.5 — Scheduler Module + Polish

**Date:** 2026-02-21

### What Changed

Extracted "is this bookmark due?" logic from hardcoded SQL into a swappable client-side module. Phase 4 can plug in SM-2, FSRS, or any other algorithm by swapping one import in `src/lib/scheduler/index.ts`.

### Files Created

| File | Purpose |
|---|---|
| `src/lib/scheduler/types.ts` | `ReviewScheduler` interface: `isDue`, `nextDue`, `intervalLabel` |
| `src/lib/scheduler/fixedInterval.ts` | `FixedIntervalScheduler` — 7-day fixed window |
| `src/lib/scheduler/index.ts` | Re-exports `activeScheduler` — the one import to swap |
| `src/lib/scheduler/__tests__/fixedInterval.test.ts` | 7 unit tests for `FixedIntervalScheduler` |
| `src/components/review/__tests__/ReviewCard.test.tsx` | 8 component tests for keyboard shortcuts |
| `sql/migrations/review-scheduler-v2.sql` | Update `get_review_queue` RPC — remove 7-day filter, raise limit to 200 |

### Files Modified

| File | Change |
|---|---|
| `src/hooks/useReview.ts` | Import `activeScheduler`; filter candidates with `isDue()`; p_limit raised to 200 |
| `src/lib/mock-supabase.ts` | `rpc('get_review_queue')`: removed 7-day date filter, return all sorted candidates |
| `src/components/review/ReviewPane.tsx` | Empty state: uses `activeScheduler.intervalLabel()` instead of hardcoded "7 days" |
| `src/components/review/ReviewCard.tsx` | `useEffect` keyboard listener (R/S/D); `<kbd>` hint badges on each action |
| `src/hooks/__tests__/useReview.test.ts` | Added test: "isDue filter applied to candidates from DB" |
| `docs/log/v3.6-review-system.md` | Appended Phase 2b.5 section |
| `docs/plan/phase-2b.md` | Marked all sections complete |
| `docs/INDEX.md` | Updated "Next up" to Phase 3 |

### Key Decisions

- **DB RPC becomes a candidate fetcher** — no interval logic in SQL, broad window (limit 200). All "is due?" decisions happen in TypeScript.
- **Keyboard shortcuts** — R (Reviewed), S (Skip), D (Open Details). Input/textarea keypresses ignored. `<kbd>` hints shown in UI.
- **`intervalLabel()` takes optional bookmark** — signature is `intervalLabel(bookmark?: Bookmark): string` so it works for both per-item display and static empty state copy without a dummy argument.
- **All statuses eligible** — no status filter at DB or client level. Unread/Reading/Read all appear in review queue.

---

## UX Polish — Sidebar / MobileNav Simplification

**Date:** 2026-02-21

### Changes

| File | Change |
|---|---|
| `src/components/layout/Sidebar.tsx` | Removed `statusNav` array (All / Unread / Reading / Done). Replaced with single "All Bookmarks" button. Removed unused `BookOpen`, `CheckCircle`, `Status` imports. |
| `src/context/UIProvider.tsx` | Default `currentStatus` changed from `'unread'` to `'all'` — app now opens showing all bookmarks. |
| `src/components/layout/MobileNav.tsx` | Removed `tabs` array (Unread / Reading status tabs). Remaining nav: Favorites · Notes · Review · View toggle. Removed unused `Inbox`, `BookOpen`, `Status` imports. |
| `src/components/ui/Badge.tsx` | `StatusBadge` `onClick` now calls `e.stopPropagation()` before the handler — prevents status badge click from bubbling to card root and opening the detail panel. |

### Rationale

Status filters (Unread / Reading / Read) are already present as inline chips in the feed toolbar (`StatusFilters.tsx`). The sidebar nav items were redundant and added visual noise. Removing them makes the nav intentional: Bookmarks → Notes → Review → Favorites.
