# v3.6 — Review System (Phase 2b.1–2b.4)

**Branch:** `feat/14-review-system` | **Issue:** #14 | **Date:** 2026-02-21

## What Was Built

Deliberate review of saved bookmarks: every item becomes a knowledge piece surfaced for recall. This is the first mechanical step toward ContentDeck's guiding vision — boosting memory and recall rather than weakening it.

## Files Created

| File | Purpose |
|---|---|
| `sql/migrations/review-system.sql` | DB migration: `last_reviewed_at`, `review_count` columns + index + `get_review_queue` RPC |
| `src/hooks/useReview.ts` | Review queue query (via `rpc`), `recordReview` mutation, session-local `skipReview`, `dueCount` |
| `src/components/review/ReviewCard.tsx` | Single bookmark card: title, excerpt, areas, last-reviewed label, Reviewed + Skip actions, progress bar |
| `src/components/review/ReviewPane.tsx` | Wraps queue + card, empty state when all caught up |
| `src/hooks/__tests__/useReview.test.ts` | 3 unit tests: full queue, skip, optimistic removal |

## Files Modified

| File | Change |
|---|---|
| `src/types/index.ts` | Added `last_reviewed_at`, `review_count` to `Bookmark`; added `'review'` to `ViewMode` |
| `src/hooks/useBookmarks.ts` | `normalizeBookmark`: defaults for new fields |
| `src/lib/demo-data.ts` | All 15 `DEMO_BOOKMARKS` entries: `last_reviewed_at: null, review_count: 0` |
| `src/lib/mock-supabase.ts` | Added `rpc()` method handling `get_review_queue` |
| `src/components/ui/Badge.tsx` | `statusLabels.done` → `'Read'` (more accurate: completed reading) |
| `src/components/feed/StatusFilters.tsx` | `labels.done` → `'Read'` |
| `src/components/layout/Sidebar.tsx` | Review nav item with Brain icon + orange `dueCount` badge |
| `src/components/layout/MobileNav.tsx` | Replaced Done status tab with Review view tab |
| `src/components/layout/AppShell.tsx` | Threaded `dueCount` prop to Sidebar + MobileNav |
| `src/pages/Dashboard.tsx` | `useReview` wired; `dueCount` to AppShell; `'review'` case in view renderer |
| `public/sw.js` | Cache bumped to `v3.2.0` |

## Key Decisions

- **Skip is session-only** — no DB write. Items return to the queue next session. This keeps the DB simple and prevents "gaming" the spaced repetition.
- **7-day interval** — fixed for now; adaptive SRS deferred to Phase 4. All items are due if never reviewed or last reviewed > 7 days ago.
- **Done → Read label** — better communicates the meaning (content was consumed). "Done" implied finality; "Read" is accurate without implying the knowledge work is done.
- **Mobile: Done tab removed** — MobileNav has 6 items; adding Review without removing something would crowd it. Done is still reachable via the status filter chips in list view.
- **`rpc()` on mock client** — added directly to the mock object (not via `MockQueryBuilder`) since RPCs return flat arrays, not chainable queries.

## Gotchas

- TypeScript: `db.rpc(...)` returns `any` without DB schema types. Added `// eslint-disable-next-line @typescript-eslint/no-unsafe-assignment` on the destructure line.
- Test fixture: added `last_reviewed_at: null, review_count: 0` to all existing bookmark fixtures in 6 test files.
- StatusFilters test: regex `/Read/i` matches "Unread" too — changed to `/^Read\s/i`.
- Review test: `recordReview` `onSettled` triggers refetch; test must mock `rpc` to return filtered queue on second call.
