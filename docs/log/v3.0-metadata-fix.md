# v3.0 — Metadata Quality Fix (1.2a) — Implementation Log

**Status:** DONE — shipped, needs real-device verification

## Why

The v1→v2 React migration lost several metadata features:
- YouTube Data API v3 integration (duration, high-res thumbnails) was dropped — only oEmbed remained
- YouTube API key input existed in Settings but did nothing
- Twitter oEmbed became unreliable after X rebrand — titles showed raw URLs
- Microlink `description` field was ignored — `excerpt` column never populated
- Feed cards only showed `reading_time`, hiding other metadata in the detail panel

## What Changed

### metadata.ts — complete overhaul

**YouTube** (Data API v3 restored):
- `extractYouTubeId()` — handles watch, youtu.be, embed, v/, shorts URLs
- `parseYouTubeDuration()` — ISO 8601 (`PT1H2M3S`) → human-readable (`1:02:03`)
- When `youtube_api_key` exists in localStorage: fetches `snippet` + `contentDetails`
- Gets: title, channelTitle, duration, maxres thumbnail, description (as excerpt)
- Falls back to oEmbed when no API key or API fails

**Twitter/X** (oEmbed + Microlink fallback):
- oEmbed: extracts actual tweet text from HTML blockquote (not just author name)
- Title format: `"Author: tweet preview..."` instead of `"Author's post"`
- When oEmbed fails entirely: falls through to Microlink (handles X.com well)

**Microlink** (excerpt extraction):
- Now extracts `description` field → stored as `excerpt`

### useBookmarks.ts — autoFetchMetadata fix
- Removed early return when `title && image` exist — metadata (duration, word_count) should still be fetched
- Added `excerpt` to the fields that get stored to DB

### BookmarkCard.tsx — richer feed cards
- YouTube cards: duration (with clock icon) + channel name
- Article cards: reading_time (preferred) or word_count as fallback
- All shown inline with domain, compact

## Key Decisions
- **Client-side YouTube API call** — key in localStorage, same pattern as OpenRouter. No edge function needed since it's a simple GET.
- **Tweet text extraction from oEmbed HTML** — regex on `<blockquote><p>` content. Fragile but oEmbed HTML format hasn't changed. Microlink fallback covers failures.
- **Excerpt truncated to 300 chars for YouTube** — video descriptions can be very long; 300 chars is enough for preview.

### Refresh metadata button
- **Problem**: Bookmarks saved via edge function (bookmarklet, iOS Shortcut, PWA share) never get client-side metadata fetch. The auto-fetch on load only ran for bookmarks missing both title AND image.
- **Fix**: Added `refreshMetadata()` to `useBookmarks` — force re-fetches and overwrites existing fields. Refresh button (spinning icon) in MetadataHeader detail panel.
- Auto-fetch on load now uses `!title || !image` (OR) instead of `!title && !image` (AND), and stores excerpt.

## Files Changed
- `src/lib/metadata.ts` — YouTube Data API, Twitter fallback chain, excerpt extraction
- `src/hooks/useBookmarks.ts` — `buildMetadataUpdates` helper, `refreshMetadata` export, autoFetchMetadata fix
- `src/components/feed/BookmarkCard.tsx` — richer metadata display on cards
- `src/components/detail/MetadataHeader.tsx` — refresh metadata button
- `src/components/detail/DetailPanel.tsx` — prop threading for refresh
- `src/pages/Dashboard.tsx` — `handleRefreshMetadata` handler, auto-fetch on load fix
